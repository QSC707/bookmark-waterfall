// ==================================================================
// --- 全局状态变量 ---
// ==================================================================
let isHoverEnabled = true;
let isDragging = false;
let suppressHover = false;
let draggedItem = null;
let dragOverTimeout = null;
let previewWindowId = null;
let currentlyHoveredItem = null;
let selectedItems = new Set();
let lastClickedId = null;


// ==================================================================
// --- 核心功能函数 ---
// ==================================================================

// --- 辅助工具函数 ---
function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }
function showToast(message, duration = 2000) { const toast = document.getElementById('toast'); if (toast) { toast.textContent = message; toast.className = 'toast show'; setTimeout(() => { toast.className = 'toast'; }, duration); } }
function sanitizeText(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
function getIconUrl(url) { return `/_favicon/?pageUrl=${encodeURIComponent(url)}&size=32`; }
function isValidUrl(string) { try { new URL(string); return true; } catch (_) { return false; } }

// --- 多选相关函数 ---
function clearSelection() { selectedItems.clear(); document.querySelectorAll('.bookmark-item.selected').forEach(el => el.classList.remove('selected')); lastClickedId = null; }
function toggleSelection(item) { const id = item.dataset.id; if (selectedItems.has(id)) { selectedItems.delete(id); item.classList.remove('selected'); } else { selectedItems.add(id); item.classList.add('selected'); } lastClickedId = id; }
function selectRange(startId, endId, column) { const items = Array.from(column.querySelectorAll('.bookmark-item')); const startIndex = items.findIndex(i => i.dataset.id === startId); const endIndex = items.findIndex(i => i.dataset.id === endId); if (startIndex === -1 || endIndex === -1) return; const [min, max] = [Math.min(startIndex, endIndex), Math.max(startIndex, endIndex)]; for (let i = min; i <= max; i++) { const item = items[i]; if (!selectedItems.has(item.dataset.id)) { selectedItems.add(item.dataset.id); item.classList.add('selected'); } } }

// --- 书签渲染与刷新 ---
function displayBookmarks(bookmarks) { const bookmarkContainer = document.getElementById('bookmarkContainer'); const header = document.querySelector('.page-header'); bookmarkContainer.innerHTML = ''; const oldTopBar = header.querySelector('.bookmark-column[data-level="0"]'); if(oldTopBar) oldTopBar.remove(); const bookmarksBar = bookmarks[0] && bookmarks[0].children[0]; if (bookmarksBar) { renderBookmarks(bookmarksBar.children, header, 0); } }
function renderBookmarks(bookmarks, parentElement, level) { let column; if (level === 0) { const header = document.querySelector('.page-header'); column = document.createElement('div'); column.className = 'bookmark-column'; column.dataset.level = level; header.appendChild(column); } else { const container = document.getElementById('bookmarkContainer'); const nextColumns = container.querySelectorAll(`.bookmark-column`); nextColumns.forEach(col => { if(parseInt(col.dataset.level) >= level) col.remove(); }); column = document.createElement('div'); column.className = 'bookmark-column'; column.dataset.level = level; container.appendChild(column); } column.addEventListener('dragover', handleColumnDragOver); column.addEventListener('dragleave', handleColumnDragLeave); column.addEventListener('drop', handleColumnDrop); const fragment = document.createDocumentFragment(); bookmarks.forEach((bookmark, index) => { const item = createBookmarkItem(bookmark, index); fragment.appendChild(item); }); if (bookmarks.length === 0 && level > 0) { const emptyMsg = document.createElement('div'); emptyMsg.className = 'empty-folder-message'; emptyMsg.textContent = '这个文件夹是空的'; column.appendChild(emptyMsg); } column.appendChild(fragment); }
function createBookmarkItem(bookmark, index) { const item = document.createElement('div'); item.className = 'bookmark-item'; item.dataset.id = bookmark.id; item.dataset.url = bookmark.url || ''; item.dataset.index = index; item.dataset.parentId = bookmark.parentId; item.draggable = true; const icon = document.createElement('img'); icon.className = 'bookmark-icon'; const isFolder = !bookmark.url; icon.src = isFolder ? '/img/folder_icon.svg' : getIconUrl(bookmark.url); icon.onerror = () => icon.src = '/img/folder_icon.svg'; const title = document.createElement('span'); title.textContent = sanitizeText(bookmark.title || 'No Title'); title.className = 'bookmark-title'; item.appendChild(icon); item.appendChild(title); if (isFolder) { item.classList.add('is-folder'); } item.addEventListener('mouseenter', () => currentlyHoveredItem = item); item.addEventListener('mouseleave', () => currentlyHoveredItem = null); item.addEventListener('mousedown', (e) => { if (e.button !== 0) return; if (e.metaKey || e.ctrlKey) { e.preventDefault(); toggleSelection(item); } else if (e.shiftKey) { e.preventDefault(); if (lastClickedId) { selectRange(lastClickedId, item.dataset.id, item.parentElement); } else { clearSelection(); toggleSelection(item); } } else { if (!selectedItems.has(item.dataset.id)) { clearSelection(); } } }); item.addEventListener('click', (e) => { if (!e.metaKey && !e.ctrlKey && !e.shiftKey) { if (!isFolder) { window.open(bookmark.url, '_blank'); } else { handleFolderClick(item, bookmark.id); } } }); function handleFolderClick(folderItem, bookmarkId) {
    clearSelection();
    const level = parseInt(folderItem.closest('.bookmark-column').dataset.level, 10);

    // 先清掉同列已有的 folder-opened
    folderItem.parentElement.querySelectorAll('.bookmark-item.folder-opened')
        .forEach(i => i.classList.remove('folder-opened'));

    const isAlreadyOpen = folderItem.classList.contains('folder-opened');

    if (!isAlreadyOpen) {
        // 给打开的文件夹加上 folder-opened
        folderItem.classList.add('folder-opened');
        chrome.bookmarks.getChildren(bookmarkId, (freshChildren) => {
            renderBookmarks(freshChildren, document.getElementById('bookmarkContainer'), level + 1);
        });
    } else {
        // 再点一次关闭
        const container = document.getElementById('bookmarkContainer');
        const nextColumns = container.querySelectorAll(`.bookmark-column`);
        nextColumns.forEach(col => {
            if (parseInt(col.dataset.level, 10) > level) col.remove();
        });
    }
} if (isFolder) { let hoverTimeout; item.addEventListener('mouseenter', () => { if (!isHoverEnabled || isDragging || suppressHover || document.body.dataset.contextMenuOpen) return; clearTimeout(hoverTimeout); hoverTimeout = setTimeout(() => { if (isDragging || selectedItems.size > 0) return; const currentHighlighted = item.parentElement.querySelector('.bookmark-item.highlighted'); if (item !== currentHighlighted) { handleFolderClick(item, bookmark.id); } }, 500); }); item.addEventListener('mouseleave', () => clearTimeout(hoverTimeout)); } item.addEventListener('dragstart', handleDragStart); item.addEventListener('dragend', handleDragEnd); item.addEventListener('dragover', handleDragOver); item.addEventListener('drop', handleDrop); item.addEventListener('dragleave', handleDragLeave); return item; }

// --- 拖拽逻辑 ---
function handleDragStart(e) { isDragging = true; draggedItem = e.target.closest('.bookmark-item'); if (!selectedItems.has(draggedItem.dataset.id)) { clearSelection(); toggleSelection(draggedItem); } const idsToDrag = Array.from(selectedItems); e.dataTransfer.setData('application/json', JSON.stringify(idsToDrag)); e.dataTransfer.effectAllowed = 'move'; queueMicrotask(() => { idsToDrag.forEach(id => { const el = document.querySelector(`.bookmark-item[data-id="${id}"]`); if(el) el.classList.add('dragging'); }); }); e.stopPropagation(); }
function handleDrop(e) { e.preventDefault(); e.stopPropagation(); clearTimeout(dragOverTimeout); const data = e.dataTransfer.getData('application/json'); if (!data) return; const idsToMove = JSON.parse(data); if (!idsToMove || idsToMove.length === 0) return; const dropTarget = e.target.closest('.bookmark-item'); if (!dropTarget || idsToMove.includes(dropTarget.dataset.id)) return; let destination = {}; const classes = dropTarget.classList; if (classes.contains('drag-enter')) { destination.parentId = dropTarget.dataset.id; destination.index = 0; } else { destination.parentId = dropTarget.dataset.parentId; let newIndex = parseInt(dropTarget.dataset.index, 10); if (classes.contains('drag-over-after') || classes.contains('drag-over-bottom')) { newIndex++; } destination.index = newIndex; } idsToMove.forEach(id => { chrome.bookmarks.move(id, destination); }); showToast(`移动了 ${idsToMove.length} 个项目`); }
function handleColumnDrop(e) { e.preventDefault(); e.stopPropagation(); const data = e.dataTransfer.getData('application/json'); if (!data) return; const idsToMove = JSON.parse(data); if (!idsToMove || idsToMove.length === 0) return; const column = e.target.closest('.bookmark-column'); column.classList.remove('column-drag-over'); let parentId = null; const level = parseInt(column.dataset.level, 10); if (level === 0) { parentId = '1'; } else { const prevColumn = document.querySelector(`.bookmark-column[data-level="${level - 1}"]`); if (prevColumn) { parentId = prevColumn.querySelector('.bookmark-item.highlighted')?.dataset.id; } } if (parentId) { idsToMove.forEach(id => { if (id) chrome.bookmarks.move(id, { parentId: parentId, index: 0 }); }); showToast(`移动了 ${idsToMove.length} 个项目`); } }
function handleDragEnd(e) { isDragging = false; clearTimeout(dragOverTimeout); document.querySelectorAll('.bookmark-item.dragging').forEach(el => el.classList.remove('dragging')); draggedItem = null; document.querySelectorAll('.bookmark-item, .bookmark-column').forEach(el => { el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-before', 'drag-over-after', 'drag-enter', 'column-drag-over', 'drop-target-active'); }); }
function handleDragOver(e) { e.preventDefault(); const targetItem = e.target.closest('.bookmark-item'); if (!targetItem) return; const data = e.dataTransfer.getData('application/json'); if (!data) return; targetItem.parentElement.querySelectorAll('.bookmark-item').forEach(item => { item.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-before', 'drag-over-after', 'drag-enter', 'drop-target-active'); }); const idsToMove = JSON.parse(data); if (idsToMove.includes(targetItem.dataset.id)) return; targetItem.classList.add('drop-target-active'); const rect = targetItem.getBoundingClientRect(); const level = targetItem.closest('.bookmark-column').dataset.level; const isFolder = targetItem.classList.contains('is-folder'); if (level == '0') { if (e.clientX < rect.left + rect.width / 2) targetItem.classList.add('drag-over-before'); else targetItem.classList.add('drag-over-after'); } else { const y = e.clientY - rect.top; if (isFolder) { if (y < rect.height * 0.25) targetItem.classList.add('drag-over-top'); else if (y > rect.height * 0.75) targetItem.classList.add('drag-over-bottom'); else { targetItem.classList.add('drag-enter'); if (!targetItem.classList.contains('highlighted')) { dragOverTimeout = setTimeout(() => { clearSelection(); handleFolderClick(targetItem, targetItem.dataset.id); }, 600); } } } else { if (y < rect.height / 2) targetItem.classList.add('drag-over-top'); else targetItem.classList.add('drag-over-bottom'); } } }
function handleDragLeave(e) { clearTimeout(dragOverTimeout); const targetItem = e.target.closest('.bookmark-item'); if (targetItem) { targetItem.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-before', 'drag-over-after', 'drag-enter', 'drop-target-active'); } }
function handleColumnDragOver(e) { e.preventDefault(); if (e.target.classList.contains('bookmark-column')) e.target.classList.add('column-drag-over'); }
function handleColumnDragLeave(e) { if (e.target.classList.contains('bookmark-column')) e.target.classList.remove('column-drag-over'); }

// --- 右键菜单 ---
function showContextMenu(e, bookmarkElement, column) { const contextMenu = document.getElementById('contextMenu'); contextMenu.innerHTML = ''; const ul = document.createElement('ul'); let menuHtml = ''; const rightClickedId = bookmarkElement?.dataset.id; document.querySelectorAll('.right-click-highlight').forEach(i => i.classList.remove('right-click-highlight')); if (rightClickedId && !selectedItems.has(rightClickedId)) { clearSelection(); toggleSelection(bookmarkElement); } else if (!rightClickedId) { clearSelection(); } const selectionSize = selectedItems.size; const hasBookmarkInSelection = Array.from(selectedItems).some(id => { const item = document.querySelector(`.bookmark-item[data-id="${id}"]`); return item && !item.classList.contains('is-folder'); }); if (selectionSize > 0) { if (selectionSize > 1) { if (hasBookmarkInSelection) { menuHtml += `<li id="open"><img src="/img/open_all.svg" class="menu-icon">打开全部 (${selectionSize})</li>`; menuHtml += `<li id="openNew"><img src="/img/open_new.svg" class="menu-icon">新窗口打开全部 (${selectionSize})</li>`; menuHtml += `<li id="openIncognito"><img src="/img/open_new.svg" class="menu-icon">隐身模式打开全部 (${selectionSize})</li>`; menuHtml += `<hr>`; } } else { const isFolder = bookmarkElement.classList.contains('is-folder'); if (isFolder) { menuHtml += `<li id="openAll"><img src="/img/open_all.svg" class="menu-icon">打开文件夹内所有书签</li><hr>`; } else { menuHtml += `<li id="open"><img src="/img/open.svg" class="menu-icon">新标签打开</li>`; menuHtml += `<li id="openNew"><img src="/img/open_new.svg" class="menu-icon">新窗口打开</li>`; menuHtml += `<li id="openIncognito"><img src="/img/open_new.svg" class="menu-icon">在隐身模式中打开</li>`; menuHtml += `<hr>`; } } if (selectionSize === 1 && !bookmarkElement.classList.contains('is-folder')) menuHtml += `<li id="editUrl"><img src="/img/edit.svg" class="menu-icon">修改网址</li>`; if (selectionSize === 1) menuHtml += `<li id="rename"><img src="/img/rename.svg" class="menu-icon">重命名</li>`; menuHtml += `<li id="move"><img src="/img/move.svg" class="menu-icon">移动${selectionSize > 1 ? ` (${selectionSize})` : ''}到...</li>`; if (selectionSize === 1 && !bookmarkElement.classList.contains('is-folder')) menuHtml += `<li id="copyUrl"><img src="/img/copy.svg" class="menu-icon">复制网址</li>`; menuHtml += `<hr>`; menuHtml += `<li id="delete"><img src="/img/delete.svg" class="menu-icon">删除${selectionSize > 1 ? ` (${selectionSize})` : ''}</li>`; } if (column) { if(menuHtml !== '') menuHtml += `<hr>`; menuHtml += `<li id="newFolder"><img src="/img/folder.svg" class="menu-icon">新建文件夹</li><hr>`; menuHtml += `<li id="sortAlphaAsc"><img src="/img/sort_asc.svg" class="menu-icon">排序：由 A 到 Z</li>`; menuHtml += `<li id="sortAlphaDesc"><img src="/img/sort_desc.svg" class="menu-icon">排序：由 Z 到 A</li>`; menuHtml += `<li id="sortDateNew"><img src="/img/sort_asc.svg" class="menu-icon">排序：从新到旧</li>`; menuHtml += `<li id="sortDateOld"><img src="/img/sort_desc.svg" class="menu-icon">排序：从旧到新</li>`; menuHtml += `<li id="sortVisit"><img src="/img/sort_asc.svg" class="menu-icon">排序：按上次打开</li>`; } ul.innerHTML = menuHtml; contextMenu.appendChild(ul); contextMenu.style.display = 'block'; const { innerWidth: winWidth, innerHeight: winHeight } = window; const { offsetWidth: menuWidth, offsetHeight: menuHeight } = contextMenu; let left = e.clientX, top = e.clientY; if (left + menuWidth > winWidth) left = winWidth - menuWidth - 5; if (top + menuHeight > winHeight) top = winHeight - menuHeight - 5; contextMenu.style.left = `${left}px`; contextMenu.style.top = `${top}px`; contextMenu.relatedTarget = bookmarkElement; contextMenu.relatedColumn = column; document.body.dataset.contextMenuOpen = 'true'; }
function handleContextMenuAction(action, element) { const selectionSize = selectedItems.size; const selectedIds = Array.from(selectedItems); if (action.startsWith('sort')) { const column = document.getElementById('contextMenu').relatedColumn; if (!column) return; let parentId; if (element && element.classList.contains('is-folder')) parentId = element.dataset.id; else if (element) parentId = element.dataset.parentId; else { const level = parseInt(column.dataset.level, 10); if (level === 0) parentId = '1'; else parentId = document.querySelector(`.bookmark-column[data-level="${level - 1}"] .bookmark-item.highlighted`)?.dataset.id; } if (parentId) handleSortBookmarks(parentId, action); return; } switch (action) { case 'open': selectedIds.forEach(id => { const item = document.querySelector(`.bookmark-item[data-id="${id}"]`); if (item && item.dataset.url) chrome.tabs.create({ url: item.dataset.url }); }); break; case 'openNew': selectedIds.forEach(id => { const item = document.querySelector(`.bookmark-item[data-id="${id}"]`); if (item && item.dataset.url) chrome.windows.create({ url: item.dataset.url }); }); break; case 'openIncognito': selectedIds.forEach(id => { const item = document.querySelector(`.bookmark-item[data-id="${id}"]`); if (item && item.dataset.url) chrome.windows.create({ url: item.dataset.url, incognito: true }); }); break; case 'delete': showConfirmDialog(`删除 ${selectionSize} 个项目`, `确定要删除这 ${selectionSize} 个选中的项目吗?`, () => { selectedIds.forEach(id => { const item = document.querySelector(`.bookmark-item[data-id="${id}"]`); if (!item) return; const isFolder = item.classList.contains('is-folder'); const promise = isFolder ? chrome.bookmarks.removeTree(id) : chrome.bookmarks.remove(id); promise.catch(err => console.error('删除失败:', err)); }); }); break; case 'move': showMoveDialog(element, selectedIds); break; case 'copyUrl': if (element) navigator.clipboard.writeText(element.dataset.url).then(() => showToast('网址已复制')); break; case 'rename': if (element) showEditDialog('重命名', element.querySelector('.bookmark-title').textContent, null, (newName) => { if(newName) chrome.bookmarks.update(element.dataset.id, { title: newName }); }); break; case 'editUrl': if (element) showEditDialog('修改网址', element.dataset.url, isValidUrl, (newUrl) => { if(newUrl) chrome.bookmarks.update(element.dataset.id, { url: newUrl }); }); break; case 'newFolder': { const column = document.getElementById('contextMenu').relatedColumn; if (!column) return; let parentId; if (element && element.classList.contains('is-folder')) parentId = element.dataset.id; else if (element) parentId = element.dataset.parentId; else { const level = parseInt(column.dataset.level, 10); if (level === 0) parentId = '1'; else parentId = document.querySelector(`.bookmark-column[data-level="${level - 1}"] .bookmark-item.highlighted`)?.dataset.id; } if (parentId) showEditDialog('新建文件夹', '', null, (name) => { if(name) chrome.bookmarks.create({ parentId, title: name, index: 0 }); }); break; } } }
async function handleSortBookmarks(parentId, sortType) { chrome.bookmarks.getChildren(parentId, async (children) => { if (!children || children.length < 2) return; showToast('正在排序...'); let sortedChildren; switch (sortType) { case 'sortDateNew': sortedChildren = children.sort((a, b) => b.dateAdded - a.dateAdded); break; case 'sortDateOld': sortedChildren = children.sort((a, b) => a.dateAdded - b.dateAdded); break; case 'sortAlphaAsc': sortedChildren = children.sort((a, b) => a.title.localeCompare(b.title)); break; case 'sortAlphaDesc': sortedChildren = children.sort((a, b) => b.title.localeCompare(a.title)); break; case 'sortVisit': const promises = children.map(child => new Promise(resolve => { if (!child.url) { resolve({ ...child, lastVisitTime: 0 }); return; } chrome.history.getVisits({ url: child.url }, (visits) => { const lastVisitTime = visits.length > 0 ? visits[visits.length - 1].visitTime : 0; resolve({ ...child, lastVisitTime }); }); })); const childrenWithVisitData = await Promise.all(promises); sortedChildren = childrenWithVisitData.sort((a, b) => b.lastVisitTime - a.lastVisitTime); break; default: return; } for (let i = 0; i < sortedChildren.length; i++) { await new Promise(resolve => chrome.bookmarks.move(sortedChildren[i].id, { parentId: parentId, index: i }, resolve)); } const parentFolderItem = document.querySelector(`.bookmark-item.highlighted[data-id="${parentId}"]`); if (parentFolderItem) { handleFolderClick(parentFolderItem, parentId); } else if (parentId === '1') { chrome.bookmarks.getTree(displayBookmarks); } showToast('排序完成'); }); }
function showEditDialog(title, initialValue, validator, callback) { const dialog = document.getElementById('editDialog'), titleEl = document.getElementById('editDialogTitle'), inputEl = document.getElementById('editDialogInput'), errorEl = document.getElementById('editDialogError'), cancelBtn = document.getElementById('cancelEdit'), confirmBtn = document.getElementById('confirmEdit'); titleEl.textContent = title; inputEl.value = initialValue || ''; errorEl.textContent = ''; dialog.style.display = 'flex'; inputEl.focus(); inputEl.select(); const close = () => { dialog.style.display = 'none'; confirmBtn.onclick = null; cancelBtn.onclick = null; inputEl.onkeydown = null; }; const confirm = () => { const newValue = inputEl.value.trim(); if (validator && !validator(newValue)) { errorEl.textContent = '请输入有效的网址'; return; } if (!newValue && (title.includes('重命名') || title.includes('新建'))) { errorEl.textContent = '名称不能为空'; return; } callback(newValue); close(); }; cancelBtn.onclick = close; confirmBtn.onclick = confirm; inputEl.onkeydown = (e) => { if (e.key === 'Enter') confirm(); if (e.key === 'Escape') close(); }; }
function showConfirmDialog(title, message, callback) { const dialog = document.getElementById('confirmDialog'), titleEl = document.getElementById('confirmDialogTitle'), messageEl = document.getElementById('confirmDialogMessage'), cancelBtn = document.getElementById('cancelConfirm'), confirmBtn = document.getElementById('confirmConfirm'); titleEl.textContent = title; messageEl.textContent = message; dialog.style.display = 'flex'; confirmBtn.focus(); const close = () => { dialog.style.display = 'none'; confirmBtn.onclick = null; cancelBtn.onclick = null; }; const confirm = () => { callback(); close(); }; cancelBtn.onclick = close; confirmBtn.onclick = confirm; }
function showMoveDialog(bookmarkElement, idsToMove) { const dialog = document.getElementById('moveDialog'), treeContainer = document.getElementById('bookmarkTree'), confirmBtn = document.getElementById('confirmMove'), cancelBtn = document.getElementById('cancelMove'); let selectedFolderId = null; let disabledFolderIds = new Set(idsToMove); const close = () => { dialog.style.display = 'none'; confirmBtn.onclick = null; cancelBtn.onclick = null; treeContainer.innerHTML = ''; }; const renderTree = (nodes, parentElement, level) => { nodes.forEach(node => { if (node.url) return; const item = document.createElement('div'); item.className = 'bookmark-tree-item'; item.dataset.id = node.id; if (disabledFolderIds.has(node.id)) item.classList.add('is-disabled'); const content = document.createElement('div'); content.className = 'folder-content'; content.style.paddingLeft = `${level * 20}px`; const expandIcon = document.createElement('span'); expandIcon.className = 'expand-icon'; const folderIcon = document.createElement('img'); folderIcon.src = '/img/folder_icon.svg'; folderIcon.className = 'folder-icon'; const title = document.createElement('span'); title.textContent = node.title || (node.id === '1' ? '书签栏' : '其他书签'); title.className = 'folder-title'; content.append(expandIcon, folderIcon, title); item.appendChild(content); const subFolderContainer = document.createElement('div'); subFolderContainer.className = 'sub-folder is-hidden'; item.appendChild(subFolderContainer); if (node.children && node.children.some(child => !child.url)) renderTree(node.children, subFolderContainer, level + 1); content.onclick = () => { if (item.classList.contains('is-disabled')) return; document.querySelectorAll('.bookmark-tree-item.selected').forEach(el => el.classList.remove('selected')); item.classList.add('selected'); selectedFolderId = node.id; confirmBtn.disabled = false; }; parentElement.appendChild(item); }); }; dialog.style.display = 'flex'; confirmBtn.disabled = true; chrome.bookmarks.getTree(tree => { const topLevelFolders = tree[0]?.children; if (!topLevelFolders) return; treeContainer.innerHTML = ''; renderTree(topLevelFolders, treeContainer, 0); treeContainer.querySelectorAll('.bookmark-tree-item').forEach(item => { const sub = item.querySelector('.sub-folder'), icon = item.querySelector('.expand-icon'); if (sub && sub.hasChildNodes()) { icon.textContent = '▶'; icon.onclick = (e) => { e.stopPropagation(); sub.classList.toggle('is-hidden'); icon.classList.toggle('expanded'); }; } }); }); confirmBtn.onclick = () => { if (selectedFolderId) { idsToMove.forEach(id => { if (id !== selectedFolderId) chrome.bookmarks.move(id, { parentId: selectedFolderId, index: 0 }); }); } close(); }; cancelBtn.onclick = close; }
function findColumnForParentId(parentId) { if (parentId === '1') return document.querySelector('.bookmark-column[data-level="0"]'); const parentItem = document.querySelector(`.bookmark-item[data-id="${parentId}"]`); if (parentItem && parentItem.classList.contains('highlighted')) { const level = parseInt(parentItem.closest('.bookmark-column').dataset.level, 10); return document.querySelector(`.bookmark-column[data-level="${level + 1}"]`); } return null; }
function reindexColumnItems(column) { if (!column) return; for (let i = 0; i < column.children.length; i++) column.children[i].dataset.index = i; }
function handleBookmarkCreated(id, bookmark) { const parentColumn = findColumnForParentId(bookmark.parentId); if (parentColumn) { const newItem = createBookmarkItem(bookmark, bookmark.index); parentColumn.insertBefore(newItem, parentColumn.children[bookmark.index]); reindexColumnItems(parentColumn); } displayRecentBookmarks(); }
function handleBookmarkRemoved(id, removeInfo) { const itemToRemove = document.querySelector(`.bookmark-item[data-id="${id}"]`); if (itemToRemove) { const parentColumn = itemToRemove.parentElement; if (itemToRemove.classList.contains('highlighted')) { const level = parseInt(parentColumn.dataset.level, 10); document.querySelectorAll('.bookmark-column').forEach(col => { if (parseInt(col.dataset.level, 10) > level) col.remove(); }); } itemToRemove.remove(); reindexColumnItems(parentColumn); } displayRecentBookmarks(); }
function handleBookmarkChanged(id, changeInfo) { document.querySelectorAll(`.bookmark-item[data-id="${id}"]`).forEach(item => { if (changeInfo.title) item.querySelector('.bookmark-title').textContent = sanitizeText(changeInfo.title); if (changeInfo.url) { item.dataset.url = changeInfo.url; item.querySelector('.bookmark-icon').src = getIconUrl(changeInfo.url); } }); }
function handleBookmarkMoved(id, moveInfo) { const itemToMove = document.querySelector(`.bookmark-item[data-id="${id}"]`); if (itemToMove) { const oldParentColumn = itemToMove.parentElement; itemToMove.remove(); reindexColumnItems(oldParentColumn); } const newParentColumn = findColumnForParentId(moveInfo.parentId); if (newParentColumn) { chrome.bookmarks.get(id, (bookmarks) => { if (bookmarks && bookmarks[0]) { const newItem = createBookmarkItem(bookmarks[0], moveInfo.index); newParentColumn.insertBefore(newItem, newParentColumn.children[moveInfo.index]); reindexColumnItems(newParentColumn); } }); } }
function displayRecentBookmarks() { const container = document.querySelector('#recentBookmarksModule .module-content'); if (!container) return; chrome.bookmarks.getRecent(15, (items) => { container.innerHTML = ''; const fragment = document.createDocumentFragment(); items.forEach(item => { if (!item.url) return; const li = document.createElement('li'), a = document.createElement('a'); a.href = item.url; a.target = '_blank'; a.title = sanitizeText(item.title); const icon = document.createElement('img'); icon.className = 'module-icon'; icon.src = getIconUrl(item.url); const title = document.createElement('span'); title.className = 'module-title'; title.textContent = sanitizeText(item.title); a.append(icon, title); li.appendChild(a); a.addEventListener('mouseenter', () => currentlyHoveredItem = a); a.addEventListener('mouseleave', () => currentlyHoveredItem = null); fragment.appendChild(li); }); container.appendChild(fragment); }); }
function displayTopSites() { const container = document.getElementById('topSitesContent'); if (!container) return; chrome.topSites.get((items) => { container.innerHTML = ''; const fragment = document.createDocumentFragment(); items.slice(0, 15).forEach(item => { const a = document.createElement('a'); a.className = 'top-site-item'; a.href = item.url; a.target = '_blank'; a.title = sanitizeText(item.title); const icon = document.createElement('img'); icon.className = 'top-site-icon'; icon.src = getIconUrl(item.url); const title = document.createElement('span'); title.className = 'top-site-title'; title.textContent = sanitizeText(item.title); a.append(icon, title); a.addEventListener('mouseenter', () => currentlyHoveredItem = a); a.addEventListener('mouseleave', () => currentlyHoveredItem = null); fragment.appendChild(a); }); container.appendChild(fragment); }); }
function handleSpacebarPreview(e) { if (e.code !== 'Space' || !currentlyHoveredItem || e.target.tagName === 'INPUT' || e.target.isContentEditable) return; e.preventDefault(); const url = currentlyHoveredItem.dataset.url || currentlyHoveredItem.href; if (url) openPreviewWindow(url); }
function openPreviewWindow(url) { if (previewWindowId !== null) { chrome.windows.get(previewWindowId, {}, (win) => { if (chrome.runtime.lastError) { previewWindowId = null; createSizedPreviewWindow(url); } else { chrome.tabs.query({ windowId: previewWindowId, active: true }, (tabs) => { if (tabs.length > 0) { chrome.tabs.update(tabs[0].id, { url: url, active: true }); chrome.windows.update(previewWindowId, { focused: true }); } }); } }); } else createSizedPreviewWindow(url); }
function createSizedPreviewWindow(url) { chrome.windows.getCurrent({}, (current) => { const w = Math.round(current.width*0.8), h = Math.round(current.height*0.9), t = current.top+Math.round((current.height-h)*0.5), l = current.left+Math.round((current.width-w)*0.5); chrome.windows.create({ url, type: 'popup', width: w, height: h, top: t, left: l }, (win) => previewWindowId = win.id); }); }
document.addEventListener('DOMContentLoaded', function () { const settingsBtn = document.getElementById('settings-btn'), settingsPanel = document.getElementById('settings-panel'), themeOptionsContainer = settingsPanel.querySelector('.theme-options'), hoverToggle = document.getElementById('hover-toggle-switch'), verticalModules = document.querySelector('.vertical-modules'), toggleVerticalBtn = document.getElementById('sidebar-toggle-btn'), contextMenu = document.getElementById('contextMenu'); const updateThemeButtons = (active) => themeOptionsContainer.querySelectorAll('.theme-option').forEach(btn => btn.classList.toggle('active', btn.dataset.themeValue === active)); const applyTheme = (theme) => { const root = document.documentElement; if (theme === 'system') root.setAttribute('data-theme', window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'); else root.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); updateThemeButtons(theme); }; applyTheme(localStorage.getItem('theme') || 'system'); hoverToggle.checked = localStorage.getItem('hoverToOpenEnabled') !== 'false'; isHoverEnabled = hoverToggle.checked; hoverToggle.addEventListener('change', (e) => { isHoverEnabled = e.target.checked; localStorage.setItem('hoverToOpenEnabled', isHoverEnabled); showToast(`悬停打开功能已${isHoverEnabled ? '开启' : '关闭'}`); }); settingsBtn.addEventListener('click', (e) => { e.stopPropagation(); settingsPanel.classList.toggle('visible'); }); themeOptionsContainer.addEventListener('click', (e) => { if (e.target.matches('.theme-option')) applyTheme(e.target.dataset.value); }); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => { if (localStorage.getItem('theme') === 'system') applyTheme('system'); }); let isModuleVisible = false, hoverTimeout; const showModules = () => { if (!isModuleVisible) { verticalModules.style.display = 'flex'; isModuleVisible = true; } }; const hideModules = () => { if (isModuleVisible) { verticalModules.style.display = 'none'; isModuleVisible = false; } }; toggleVerticalBtn.addEventListener('click', (e) => { e.stopPropagation(); isModuleVisible ? hideModules() : showModules(); }); toggleVerticalBtn.addEventListener('mouseenter', () => { clearTimeout(hoverTimeout); hoverTimeout = setTimeout(showModules, 500); }); toggleVerticalBtn.addEventListener('mouseleave', () => clearTimeout(hoverTimeout)); verticalModules.addEventListener('mouseenter', () => clearTimeout(hoverTimeout)); document.addEventListener('click', (e) => { if (!e.target.closest('.bookmark-item')) clearSelection(); if (settingsPanel.classList.contains('visible') && !settingsPanel.contains(e.target) && !settingsBtn.contains(e.target)) settingsPanel.classList.remove('visible'); if (contextMenu.style.display === 'block' && !contextMenu.contains(e.target)) { contextMenu.style.display = 'none'; document.querySelectorAll('.right-click-highlight').forEach(i => i.classList.remove('right-click-highlight')); delete document.body.dataset.contextMenuOpen; } if (isModuleVisible && !verticalModules.contains(e.target) && !toggleVerticalBtn.contains(e.target)) hideModules(); }); document.body.addEventListener('contextmenu', (e) => { const item = e.target.closest('.bookmark-item'), column = e.target.closest('.bookmark-column'); if (!item && !column) return; e.preventDefault(); showContextMenu(e, item, column); }); contextMenu.addEventListener('click', (e) => { const li = e.target.closest('li'); if (li && li.id) { handleContextMenuAction(li.id, contextMenu.relatedTarget); } }); chrome.bookmarks.getTree(displayBookmarks); displayRecentBookmarks(); displayTopSites(); chrome.bookmarks.onCreated.addListener(handleBookmarkCreated); chrome.bookmarks.onRemoved.addListener(handleBookmarkRemoved); chrome.bookmarks.onChanged.addListener(handleBookmarkChanged); chrome.bookmarks.onMoved.addListener(handleBookmarkMoved); document.addEventListener('keydown', handleSpacebarPreview); chrome.windows.onRemoved.addListener((id) => { if (id === previewWindowId) previewWindowId = null; }); });